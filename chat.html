<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Yanlik â€¢ Sohbet</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#000814;--bg2:#001d3d;--fg:#e8f0ff;--muted:#9bb3cc;--acc:#00c9ff;--acc2:#0077ff;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Roboto,Arial;
      margin:0; height:100vh; display:flex; flex-direction:column;
      background: radial-gradient(1000px 600px at 10% 0%, #02182a 0%, #000 60%);
      color:var(--fg);
    }
    header, footer{
      background:rgba(0,0,0,.35); backdrop-filter:blur(8px);
      padding:12px 16px;
    }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:700; color:var(--acc); text-shadow:0 0 10px #00c9ff77;}
    .pill{ background:#0f1b2e; border:1px solid rgba(255,255,255,.06); padding:6px 8px; border-radius:999px; color:var(--muted); }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    select, .seg{
      background:#0f1b2e; color:#fff; border:1px solid rgba(255,255,255,.06);
      border-radius:10px; padding:8px 10px;
    }
    .seg{ display:flex; gap:4px; }
    .seg button{
      border:0; background:transparent; color:#9fd3ff; padding:6px 10px; border-radius:8px; cursor:pointer;
    }
    .seg button.active{ background:linear-gradient(135deg,var(--acc2),var(--acc)); color:#02131a; font-weight:700; }
    main{ flex:1; overflow-y:auto; padding:12px 16px; }
    .row{ display:flex; gap:8px; }
    .msg{
      margin:10px 0; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.04);
      max-width:880px;
    }
    .me{ background:linear-gradient(180deg, rgba(0,201,255,.12), rgba(255,255,255,.03)); border-color:#00c9ff33;}
    .meta{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .typing{ font-size:12px; color:var(--muted); display:none; gap:6px; align-items:center; }
    .dot{ width:6px; height:6px; border-radius:50%; background:var(--muted); animation:b 1s infinite alternate; }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes b { to{ transform:translateY(-2px); opacity:.6; } }
    footer{ display:flex; flex-direction:column; gap:8px; }
    input{
      flex:1; background:#0e1423; color:#fff; border:0; border-radius:10px; padding:12px;
    }
    button.send{
      background:linear-gradient(135deg,var(--acc2),var(--acc));
      border:0; color:#02131a; font-weight:800; padding:12px 16px; border-radius:10px; cursor:pointer;
    }
    .quick{ display:flex; gap:8px; flex-wrap:wrap; }
    .quick button{
      background:#0f1b2e; border:1px solid rgba(255,255,255,.06); color:#9fd3ff;
      padding:6px 10px; border-radius:999px; cursor:pointer;
    }
  </style>
</head>
<body>
  <script src="./auth.js"></script>
  <script>
    const sess = YANLIK_AUTH.requireAuth('login.html'); // giriÅŸ zorunlu
    if(!sess) document.write("YÃ¶nlendiriliyorsunuz...");
  </script>

  <header>
    <div class="brand">ðŸ’¬ YanlikAI <span class="pill" id="userBadge">yÃ¼kleniyorâ€¦</span></div>
    <div class="controls">
      <!-- Mod -->
      <div class="seg" id="modeSeg" role="tablist" aria-label="Mod">
        <button data-mode="empathy" class="active">Empati</button>
        <button data-mode="assistant">Asistan</button>
      </div>
      <!-- Ton -->
      <div class="seg" id="toneSeg" role="tablist" aria-label="Ton">
        <button data-tone="soft" class="active">YumuÅŸak</button>
        <button data-tone="neutral">NÃ¶tr</button>
      </div>
      <!-- Dil -->
      <select id="langSel" title="Dil">
        <option value="auto" selected>Dil: Otomatik</option>
        <option value="tr">TÃ¼rkÃ§e</option>
        <option value="en">English</option>
      </select>
      <button class="seg" id="logoutBtn" title="Ã‡Ä±kÄ±ÅŸ">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </header>

  <main id="chatList"></main>

  <div class="typing" id="typing"><span>YanlikAI yazÄ±yor</span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>

  <footer>
    <div class="quick" id="quick">
      <button data-t="Selam!">Selam!</button>
      <button data-t="Biraz moralim bozuk.">Biraz moralim bozuk.</button>
      <button data-t="Bana hÄ±zlÄ± bir Ã§alÄ±ÅŸma planÄ± verir misin?">Ã‡alÄ±ÅŸma planÄ±</button>
      <button data-t="BugÃ¼n verimli olmak iÃ§in 3 kÃ¼Ã§Ã¼k adÄ±m?">3 kÃ¼Ã§Ã¼k adÄ±m</button>
    </div>
    <div class="row">
      <input id="msgInput" placeholder="Mesaj yaz ve Enterâ€™a bas..." autocomplete="off"/>
      <button class="send" id="sendBtn">GÃ¶nder</button>
    </div>
  </footer>

  <script>
    // ===== UI refs
    const list = document.getElementById("chatList");
    const input = document.getElementById("msgInput");
    const btn   = document.getElementById("sendBtn");
    const badge = document.getElementById("userBadge");
    const typing= document.getElementById("typing");
    const langSel = document.getElementById("langSel");

    // ===== Session info
    const me = YANLIK_AUTH.getSession();
    badge.textContent = `${me.display} (${me.role})`;

    // ===== Mode / Tone
    let MODE = "empathy"; // empathy | assistant
    let TONE = "soft";    // soft | neutral

    document.getElementById("modeSeg").onclick = (e)=>{
      if(e.target.tagName!=="BUTTON") return;
      MODE = e.target.dataset.mode;
      [...e.currentTarget.children].forEach(b=>b.classList.toggle("active", b.dataset.mode===MODE));
    };
    document.getElementById("toneSeg").onclick = (e)=>{
      if(e.target.tagName!=="BUTTON") return;
      TONE = e.target.dataset.tone;
      [...e.currentTarget.children].forEach(b=>b.classList.toggle("active", b.dataset.tone===TONE));
    };

    // ===== Logout
    document.getElementById("logoutBtn").onclick = ()=>{
      YANLIK_AUTH.logout(); location.href="login.html";
    };

    // ===== Helpers
    function fmt(t){ return new Date(t).toLocaleTimeString("tr-TR",{hour:'2-digit',minute:'2-digit'}); }
    function esc(x){ return (x||"").replace(/</g,"&lt;"); }
    function render(){
      const chats = YANLIK_AUTH.listChats();
      list.innerHTML = chats.slice(-200).map(c=>`
        <div class="msg ${c.from===me.username?'me':''}">
          <div class="meta">${fmt(c.at)} â€¢ <strong>${esc(c.from)}</strong> [${c.role}]</div>
          <div>${esc(c.text)}</div>
        </div>
      `).join("");
      list.scrollTop = list.scrollHeight;
    }

    // ===== Language detection (very simple)
    function detectLang(s){
      if(langSel.value!=="auto") return langSel.value;
      const trWords = ["merhaba","selam","nasÄ±l","Ã¼zgÃ¼n","moral","yardÄ±m","teÅŸekkÃ¼r","lÃ¼tfen","kanka","kanki","knk"];
      const enWords = ["hello","hi","how","sad","help","thanks","please","buddy"];
      const L = s.toLowerCase();
      let trScore = trWords.reduce((a,w)=>a+(L.includes(w)?1:0),0);
      // contains Turkish chars?
      if(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼]/i.test(s)) trScore+=2;
      let enScore = enWords.reduce((a,w)=>a+(L.includes(w)?1:0),0);
      return trScore>=enScore ? "tr" : "en";
    }

    // ===== Sentiment (very rough)
    const NEG = ["Ã¼zgÃ¼n","moralim bozuk","kÃ¶tÃ¼ hissediyorum","bunaldÄ±m","yorgunum","kaygÄ±","anksiyete","depresif","aÄŸlÄ±yorum","zor","stres","korku","endiÅŸe","yalnÄ±zÄ±m"];
    const POS = ["harika","mÃ¼kemmel","iyi","sÃ¼per","seviniyorum","mutlu","ÅŸahane","baÅŸardÄ±m"];
    function polarity(s){
      const L=s.toLowerCase();
      let score=0;
      NEG.forEach(w=>{ if(L.includes(w)) score--; });
      POS.forEach(w=>{ if(L.includes(w)) score++; });
      return score; // -neg .. +pos
    }

    // ===== Crisis detection (self-harm / safety)
    function isCrisis(s){
      const L=s.toLowerCase();
      const keys = [
        "intihar","kendime zarar","yaÅŸamak istemiyorum","kendimi Ã¶ldÃ¼receÄŸim","bÄ±Ã§ak","canÄ±ma kÄ±y",
        "suicide","kill myself","self harm"
      ];
      return keys.some(k=>L.includes(k));
    }

    // ===== Bot core
    function replyEmpathy(lang, text){
      const score = polarity(text);
      const soft = TONE==="soft";
      const openQ = lang==="tr"
        ? ["Bunu ne zamandÄ±r hissediyorsun?","Sence bu duyguyu tetikleyen ne olmuÅŸ olabilir?","Åžu an sana en Ã§ok ne iyi gelir?","Bunu yalnÄ±z taÅŸÄ±mak zorunda deÄŸilsin, istersen kÃ¼Ã§Ã¼k bir plan yapalÄ±m."]
        : ["How long have you been feeling this?","What do you think triggered it?","What would help you most right now?","You donâ€™t have to carry this aloneâ€”shall we make a tiny plan?"];
      const ground = lang==="tr"
        ? "Topraklanma denemesi: gÃ¶rdÃ¼ÄŸÃ¼n 5 ÅŸey, dokunduÄŸun 4 ÅŸey, duyduÄŸun 3 ses, aldÄ±ÄŸÄ±n 2 koku, 1 tat."
        : "Grounding: 5 things you see, 4 you touch, 3 sounds, 2 smells, 1 taste.";

      if(isCrisis(text)){
        return lang==="tr"
          ? "Bunu duyduÄŸuma Ã§ok Ã¼zÃ¼ldÃ¼m ve ciddiye alÄ±yorum. **GÃ¼venliÄŸin en Ã¶ncelikli.** LÃ¼tfen ÅŸu an gÃ¼vendiÄŸin birini ara veya bulunduÄŸun yerde acil hizmetleri **112**â€™yi ara. Ä°stersen birlikte nefesi yavaÅŸlatÄ±p 4-4-6 nefes (4 sn al, 4 sn tut, 6 sn ver) yapalÄ±m. Åžu an yanÄ±ndayÄ±m; istersen birkaÃ§ dakikalÄ±k bir destek planÄ± da yapabiliriz."
          : "Iâ€™m really sorry youâ€™re feeling this. **Your safety matters most.** Please contact someone you trust right now or call your local emergency number. If youâ€™re in TÃ¼rkiye, dial **112**. We can also do a quick 4-4-6 breathing to settle a bit. Iâ€™m here, and we can make a short support plan together.";
      }

      // gentle templates
      if(score<=-1){
        return lang==="tr"
          ? `${soft?"Seni duyuyorum; zor bir ÅŸey taÅŸÄ±yorsun. ":""}BÃ¶yle hissetmen Ã§ok anlaÅŸÄ±lÄ±r. ${ground} \n\n${openQ[0]}`
          : `${soft?"I hear you; youâ€™re carrying something heavy. ":""}Itâ€™s totally understandable to feel this way. ${ground}\n\n${openQ[0]}`;
      }
      if(score>=1){
        return lang==="tr"
          ? `${soft?"Sevindim! ":""}Bu hissi korumak iÃ§in bugÃ¼n **kÃ¼Ã§Ã¼k 1 adÄ±m** seÃ§elim mi? Mesela 20 dk odak + 5 dk mola. ${openQ[2]}`
          : `${soft?"Love to hear that! ":""}To keep the momentum, shall we pick **one tiny step** for today? e.g., 20m focus + 5m break. ${openQ[2]}`;
      }
      // neutral
      return lang==="tr"
        ? `${soft?"AnlÄ±yorum, biraz karmaÅŸÄ±k gÃ¶rÃ¼nÃ¼yor. ":""}Ä°stersen iki yoldan ilerleyelim: (1) duyguyu dÃ¼zenleyecek mini rutin, (2) sorunun kÃ¶kÃ¼ne inen 1-2 soru. ${openQ[1]}`
        : `${soft?"Got itâ€”this feels a bit tangled. ":""}We can try two tracks: (1) a tiny regulation routine, (2) 1â€“2 root-cause questions. ${openQ[1]}`;
    }

    function replyAssistant(lang, text){
      const L=text.toLowerCase();

      // quick intents
      if(/(selam|merhaba|hello|hi)\b/.test(L)){
        return lang==="tr" ? "Selam! NasÄ±l yardÄ±mcÄ± olabilirim? Ä°stersen bir hedef yaz, 3 kÃ¼Ã§Ã¼k adÄ±ma bÃ¶lelim." :
                             "Hey there! How can I help? Share a goal and weâ€™ll break it into 3 tiny steps.";
      }
      if(/(plan|Ã§alÄ±ÅŸma planÄ±|study plan)/.test(L)){
        return lang==="tr"
          ? "HÄ±zlÄ± Ã§alÄ±ÅŸma planÄ±: 1) 25 dk odak (Pomodoro) Ã— 3, 2) 10 dk Ã¶zet Ã§Ä±kar, 3) 15 dk test Ã§Ã¶z. AkÅŸam 20 dk tekrar. HazÄ±r mÄ±yÄ±z?"
          : "Quick study plan: 1) 25m focus (Pomodoro) Ã— 3, 2) 10m notes/summary, 3) 15m quiz. Evening: 20m review. Ready?";
      }
      if(/(3 kÃ¼Ã§Ã¼k adÄ±m|3 small steps|3 steps)/.test(L)){
        return lang==="tr"
          ? "BugÃ¼n iÃ§in 3 kÃ¼Ã§Ã¼k adÄ±m: (1) 15 dk derli toplu alan hazÄ±rlÄ±ÄŸÄ±, (2) 20 dk tek gÃ¶rev, (3) 5 dk mini rapor (ne yaptÄ±m, sÄ±rada ne var)."
          : "Three tiny steps for today: (1) 15m tidy workspace, (2) 20m single-task focus, (3) 5m mini report (done + next).";
      }

      // fallback: general helpful tone
      return lang==="tr"
        ? "AnladÄ±m. Bunu netleÅŸtirmek iÃ§in 1 hedef, 1 engel ve 1 sonraki adÄ±mÄ± yazalÄ±m mÄ±? Ä°stersen Ã¶rnek bir ÅŸablon vereyim."
        : "Got it. Shall we note 1 goal, 1 obstacle, and 1 next step? I can give you a quick template.";
    }

    function composeReply(text){
      const lang = detectLang(text);
      if(MODE==="empathy") return replyEmpathy(lang, text);
      return replyAssistant(lang, text);
    }

    // ===== Send & bot
    function pushMine(text){
      YANLIK_AUTH.pushChat({ from: me.username, role: me.role, text });
    }
    function pushBot(text){
      YANLIK_AUTH.pushChat({ from: "YanlikAI", role: "bot", text });
    }

    async function send(){
      const text = input.value.trim();
      if(!text) return;
      pushMine(text);
      input.value=""; render();

      // typingâ€¦
      typing.style.display="inline-flex";
      await new Promise(r=>setTimeout(r, Math.min(1200, 300 + text.length*15)));

      const botText = composeReply(text);
      pushBot(botText);
      typing.style.display="none";
      render();
    }

    btn.onclick = send;
    input.addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });

    // Quick prompts
    document.getElementById("quick").onclick = (e)=>{
      if(e.target.tagName!=="BUTTON") return;
      input.value = e.target.dataset.t;
      input.focus();
    };

    // init
    render();
    setInterval(render, 5000);
  </script>
</body>
</html>