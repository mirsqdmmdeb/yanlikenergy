<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Yanlik â€¢ Sohbet</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#000814;--fg:#e8f0ff;--muted:#9bb3cc;--acc:#00c9ff;--acc2:#0077ff;
      --card:#0f1b2e; --panel:#121a2b;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Roboto,Arial;
      margin:0; height:100vh; display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 64px 1fr 120px;
      grid-template-areas:
        "side header"
        "side main"
        "side footer";
      background: radial-gradient(1000px 600px at 10% 0%, #02182a 0%, #000 60%);
      color:var(--fg);
    }
    header{
      grid-area:header; background:rgba(0,0,0,.35); backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px;
    }
    .brand{display:flex;align-items:center;gap:10px;color:var(--acc);font-weight:800;text-shadow:0 0 10px #00c9ff77}
    .pill{background:#0f1b2e;border:1px solid rgba(255,255,255,.06);padding:6px 8px;border-radius:999px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .seg{display:flex;gap:4px;background:#0f1b2e;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:2px}
    .seg button{border:0;background:transparent;color:#9fd3ff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .seg button.active{background:linear-gradient(135deg,var(--acc2),var(--acc));color:#02131a;font-weight:800}
    select, .chip{
      background:#0f1b2e;color:#fff;border:1px solid rgba(255,255,255,.06);
      border-radius:10px;padding:8px 10px
    }
    .chip{cursor:pointer}
    #side{
      grid-area:side;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);padding:12px;border-right:1px solid rgba(255,255,255,.08);
      display:flex;flex-direction:column;gap:12px;overflow:auto;
    }
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
    .title{font-weight:800;color:#9fd3ff;margin:4px 0 8px}
    .row{display:flex;gap:8px}
    .col{display:flex;flex-direction:column;gap:8px}
    .rooms li{list-style:none;margin:6px 0;display:flex;justify-content:space-between;gap:8px}
    .rooms button{border:0;border-radius:8px;padding:4px 8px;background:#162541;color:#9fd3ff;cursor:pointer}
    .rooms button.active{background:linear-gradient(135deg,var(--acc2),var(--acc));color:#02131a;font-weight:800}
    .muted{color:var(--muted)}
    main{ grid-area:main; overflow:auto; padding:12px 16px;}
    .msg{ margin:10px 0; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.04); max-width:900px}
    .me{ background:linear-gradient(180deg, rgba(0,201,255,.12), rgba(255,255,255,.03)); border-color:#00c9ff33;}
    .meta{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .trline{margin-top:6px;font-size:13px;color:#d7eaff}
    .hint{font-size:12px;color:#88a9c9}
    #typing{ display:none; color:var(--muted); font-size:12px; gap:6px; align-items:center; margin:8px 0 }
    .dot{ width:6px; height:6px; border-radius:50%; background:var(--muted); animation:b 1s infinite alternate; }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes b { to{ transform:translateY(-2px); opacity:.6; } }
    footer{
      grid-area:footer; background:rgba(0,0,0,.35); backdrop-filter:blur(8px);
      padding:10px 12px; display:flex; flex-direction:column; gap:8px;
    }
    input, textarea{
      background:#0e1423;color:#fff;border:0;border-radius:10px;padding:10px
    }
    .send{background:linear-gradient(135deg,var(--acc2),var(--acc));border:0;color:#02131a;font-weight:800;
      padding:12px 16px;border-radius:10px;cursor:pointer}
    .quick{display:flex;gap:8px;flex-wrap:wrap}
    .quick button{background:#0f1b2e;border:1px solid rgba(255,255,255,.06);color:#9fd3ff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .bar{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .danger{background:#ff6b6b;color:#fff;border:0;border-radius:8px;padding:6px 8px;cursor:pointer}
  </style>
</head>
<body>
  <script src="./auth.js"></script>
  <script>
    const sess = YANLIK_AUTH.requireAuth('login.html'); // giriÅŸ ÅŸart
    if(!sess) document.write("YÃ¶nlendiriliyorsunuz...");
  </script>

  <!-- SOL PANEL: Rooms + Åžablonlar + Notlar -->
  <aside id="side">
    <!-- Rooms -->
    <div class="card">
      <div class="title">Kanallar</div>
      <ul id="roomList" class="rooms"></ul>
      <div class="row">
        <input id="roomName" placeholder="Yeni kanal adÄ±" />
        <button id="addRoom" class="chip">Ekle</button>
      </div>
      <p class="hint">Not: Admin paneli global akÄ±ÅŸÄ± gÃ¶sterir; odalar bu sayfaya Ã¶zel ek katmandÄ±r.</p>
    </div>

    <!-- Åžablonlar -->
    <div class="card">
      <div class="title">Åžablonlar</div>
      <div class="col" id="tpls"></div>
    </div>

    <!-- NotlarÄ±m -->
    <div class="card">
      <div class="title">NotlarÄ±m</div>
      <textarea id="notes" rows="8" placeholder="KÄ±sa notlarÄ±nÄ± buraya kaydet..."></textarea>
      <div class="row">
        <button id="saveNotes" class="chip">Kaydet</button>
        <button id="clearNotes" class="danger">Temizle</button>
      </div>
      <p class="hint">Notlar cihazÄ±nda saklanÄ±r (LocalStorage).</p>
    </div>
  </aside>

  <!-- ÃœST BAR -->
  <header>
    <div class="brand">ðŸ’¬ YanlikAI <span class="pill" id="userBadge">yÃ¼kleniyorâ€¦</span></div>
    <div class="controls">
      <!-- Mod -->
      <div class="seg" id="modeSeg" role="tablist" aria-label="Mod">
        <button data-mode="empathy" class="active">Empati</button>
        <button data-mode="assistant">Asistan</button>
      </div>
      <!-- Ton -->
      <div class="seg" id="toneSeg" role="tablist" aria-label="Ton">
        <button data-tone="soft" class="active">YumuÅŸak</button>
        <button data-tone="neutral">NÃ¶tr</button>
      </div>
      <!-- Dil -->
      <select id="langSel" title="Dil">
        <option value="auto" selected>Dil: Otomatik</option>
        <option value="tr">TÃ¼rkÃ§e</option>
        <option value="en">English</option>
      </select>
      <!-- Ã‡eviri -->
      <div class="seg" id="trSeg" title="Yan Ã§eviri">
        <button data-tr="off" class="active">Ã‡eviri: KapalÄ±</button>
        <button data-tr="tr">â†’ TÃ¼rkÃ§e</button>
        <button data-tr="en">â†’ English</button>
      </div>
      <button class="chip" id="logoutBtn" title="Ã‡Ä±kÄ±ÅŸ">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </header>

  <!-- MESAJLAR -->
  <main id="chatList"></main>
  <div id="typing"><span>YanlikAI yazÄ±yor</span> <span class="dot"></span><span class="dot"></span><span class="dot"></span></div>

  <!-- GÃ–NDERME ALANI -->
  <footer>
    <div class="quick" id="quick"></div>
    <div class="bar">
      <input id="msgInput" class="grow" placeholder="Mesaj yaz ve Enterâ€™a bas..." autocomplete="off"/>
      <button id="sendBtn" class="send">GÃ¶nder</button>
    </div>
  </footer>

  <script>
    // ======= Basit depolar (client-only ek Ã¶zellikler)
    const LS_ROOMS = "yanlik:rooms";
    const LS_NOTES = (user)=>`yanlik:notes:${user}`;
    const me = YANLIK_AUTH.getSession();

    // BaÅŸlÄ±k rozeti
    document.getElementById("userBadge").textContent = `${me.display} (${me.role})`;

    // ======= Room store (admin global feedâ€™i bozmadan, ek katman)
    function readRooms(){
      try{ return JSON.parse(localStorage.getItem(LS_ROOMS)) || { current:"Genel", items:["Genel"] }; }
      catch{ return { current:"Genel", items:["Genel"] }; }
    }
    function writeRooms(x){ localStorage.setItem(LS_ROOMS, JSON.stringify(x)); }
    let ROOMS = readRooms(); // { current, items[] }

    // ======= Notlar
    const notesEl = document.getElementById("notes");
    notesEl.value = localStorage.getItem(LS_NOTES(me.username)) || "";
    document.getElementById("saveNotes").onclick = ()=>{ localStorage.setItem(LS_NOTES(me.username), notesEl.value); };
    document.getElementById("clearNotes").onclick = ()=>{ if(confirm("NotlarÄ± temizle?")){ notesEl.value=""; localStorage.removeItem(LS_NOTES(me.username)); } };

    // ======= UI refs
    const list = document.getElementById("chatList");
    const input = document.getElementById("msgInput");
    const btn   = document.getElementById("sendBtn");
    const typing= document.getElementById("typing");
    const langSel = document.getElementById("langSel");
    const quickBox= document.getElementById("quick");

    // ======= Mod / Ton / Ã‡eviri
    let MODE="empathy", TONE="soft", TR_TARGET="off";
    document.getElementById("modeSeg").onclick = (e)=>{ if(e.target.tagName!=="BUTTON") return; MODE=e.target.dataset.mode; [...e.currentTarget.children].forEach(b=>b.classList.toggle("active", b.dataset.mode===MODE)); };
    document.getElementById("toneSeg").onclick = (e)=>{ if(e.target.tagName!=="BUTTON") return; TONE=e.target.dataset.tone; [...e.currentTarget.children].forEach(b=>b.classList.toggle("active", b.dataset.tone===TONE)); };
    document.getElementById("trSeg").onclick   = (e)=>{ if(e.target.tagName!=="BUTTON") return; TR_TARGET=e.target.dataset.tr; [...e.currentTarget.children].forEach(b=>b.classList.toggle("active", b.dataset.tr===TR_TARGET)); render(); };

    // ======= Rooms UI
    const roomList = document.getElementById("roomList");
    function renderRooms(){
      roomList.innerHTML = (ROOMS.items||[]).map(r=>`
        <li>
          <button class="${r===ROOMS.current?'active':''}" onclick="setRoom('${r.replace(/'/g,"&#39;")}')"># ${r}</button>
          ${r!=="Genel"?`<button onclick="delRoom('${r.replace(/'/g,"&#39;")}')">Sil</button>`:""}
        </li>
      `).join("");
    }
    window.setRoom = (name)=>{ ROOMS.current = name; writeRooms(ROOMS); render(); renderRooms(); };
    window.delRoom = (name)=>{
      if(!confirm(`#${name} silinsin mi?`)) return;
      ROOMS.items = ROOMS.items.filter(x=>x!==name);
      if(ROOMS.current===name) ROOMS.current="Genel";
      writeRooms(ROOMS); renderRooms(); render();
    };
    document.getElementById("addRoom").onclick = ()=>{
      const v = (document.getElementById("roomName").value||"").trim();
      if(!v) return;
      if(!ROOMS.items.includes(v)) ROOMS.items.push(v);
      ROOMS.current = v;
      document.getElementById("roomName").value="";
      writeRooms(ROOMS); renderRooms(); render();
    };
    renderRooms();

    // ======= Quick templates (odaâ€™ya gÃ¶re Ã¶neriler)
    const TEMPLATES = {
      Genel: [
        "Selam! BugÃ¼n nasÄ±lsÄ±n?",
        "Biraz moralim bozuk.",
        "BugÃ¼n iÃ§in 3 kÃ¼Ã§Ã¼k adÄ±m Ã¶ner."
      ],
      "Ã‡alÄ±ÅŸma": [
        "HÄ±zlÄ± Ã§alÄ±ÅŸma planÄ± yapar mÄ±sÄ±n?",
        "Pomodoro ile 2 saatlik plan oluÅŸtur.",
        "Zaman yÃ¶netimi iÃ§in ipuÃ§larÄ± ver."
      ],
      "Destek": [
        "KaygÄ±mÄ± azaltmak iÃ§in nefes egzersizi ver.",
        "Topraklanma tekniÄŸi anlatÄ±r mÄ±sÄ±n?",
        "KÄ±sa bir motivasyon cÃ¼mlesi yaz."
      ]
    };
    function renderTemplates(){
      const list = TEMPLATES[ROOMS.current] || TEMPLATES.GENEL || TEMPLATES["Genel"];
      quickBox.innerHTML = (list||[]).map(t=>`<button data-t="${t.replace(/"/g,"&quot;")}">${t}</button>`).join("");
    }
    quickBox.onclick = (e)=>{ if(e.target.tagName!=="BUTTON") return; input.value=e.target.dataset.t; input.focus(); };

    // ======= Dil algÄ±lama + basit (yerel) Ã§eviri (deneysel)
    function detectLang(s){
      if(langSel.value!=="auto") return langSel.value;
      const trQ = ["merhaba","selam","nasÄ±l","Ã¼zgÃ¼n","moral","yardÄ±m","teÅŸekkÃ¼r","lÃ¼tfen","kanka","kanki","knk"];
      const enQ = ["hello","hi ","how ","sad","help","thanks","please","buddy"];
      const L = s.toLowerCase();
      let trScore = trQ.reduce((a,w)=>a+(L.includes(w)?1:0),0);
      if(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼]/i.test(s)) trScore+=2;
      let enScore = enQ.reduce((a,w)=>a+(L.includes(w)?1:0),0);
      return trScore>=enScore ? "tr" : "en";
    }
    // mini sÃ¶zlÃ¼k: yalnÄ±z kÄ±sa cÃ¼mleleri idare eder
    const DICT_TR_EN = {
      "merhaba":"hello","selam":"hi","nasÄ±lsÄ±n":"how are you","moralim bozuk":"i feel down",
      "yardÄ±m":"help","lÃ¼tfen":"please","teÅŸekkÃ¼r":"thanks","kÃ¼Ã§Ã¼k adÄ±m":"small step",
      "nefes egzersizi":"breathing exercise","topraklanma":"grounding"
    };
    const DICT_EN_TR = {
      "hello":"merhaba","hi":"selam","how are you":"nasÄ±lsÄ±n","i feel down":"moralim bozuk",
      "help":"yardÄ±m","please":"lÃ¼tfen","thanks":"teÅŸekkÃ¼rler","small step":"kÃ¼Ã§Ã¼k adÄ±m",
      "breathing exercise":"nefes egzersizi","grounding":"topraklanma"
    };
    function naiveTranslate(s, target){
      const L = s.toLowerCase();
      const map = target==="en" ? DICT_TR_EN : DICT_EN_TR;
      let out = s;
      Object.keys(map).forEach(k=>{
        const re = new RegExp("\\b"+k+"\\b","gi");
        out = out.replace(re, (m)=> {
          const t = map[k];
          // bÃ¼yÃ¼k harf korumasÄ± (basit)
          if(m[0]===m[0].toUpperCase()) return t.charAt(0).toUpperCase()+t.slice(1);
          return t;
        });
      });
      return out;
    }

    // ======= Empati / Asistan botu (Ã¶nceki sÃ¼rÃ¼mden)
    const NEG = ["Ã¼zgÃ¼n","moralim bozuk","kÃ¶tÃ¼ hissediyorum","bunaldÄ±m","yorgunum","kaygÄ±","anksiyete","depresif","aÄŸlÄ±yorum","zor","stres","korku","endiÅŸe","yalnÄ±zÄ±m"];
    const POS = ["harika","mÃ¼kemmel","iyi","sÃ¼per","seviniyorum","mutlu","ÅŸahane","baÅŸardÄ±m"];
    function polarity(s){ const L=s.toLowerCase(); let sc=0; NEG.forEach(w=>{ if(L.includes(w)) sc--; }); POS.forEach(w=>{ if(L.includes(w)) sc++; }); return sc; }
    function isCrisis(s){
      const L=s.toLowerCase();
      return ["intihar","kendime zarar","yaÅŸamak istemiyorum","kendimi Ã¶ldÃ¼receÄŸim","canÄ±ma kÄ±y","suicide","kill myself","self harm"].some(k=>L.includes(k));
    }
    function replyEmpathy(lang, text){
      const sc = polarity(text);
      const soft = TONE==="soft";
      const openQ = lang==="tr" ? ["Bunu ne zamandÄ±r hissediyorsun?","Sence tetikleyen ne oldu?","Åžu an en Ã§ok ne iyi gelir?","Ä°stersen kÃ¼Ã§Ã¼k bir plan yapalÄ±m."] : ["How long have you felt this?","What do you think triggered it?","What would help most right now?","We can make a tiny plan if you want."];
      const ground = lang==="tr" ? "Topraklanma: 5 gÃ¶r, 4 dokun, 3 ses, 2 koku, 1 tat." : "Grounding: 5 see, 4 touch, 3 sounds, 2 smells, 1 taste.";
      if(isCrisis(text)){
        return lang==="tr" ? "Bunu ciddiye alÄ±yorum. **GÃ¼venliÄŸin Ã¶ncelik.** YakÄ±nÄ±nÄ± ara veya **112**â€™yi ara. Ä°stersen 4-4-6 nefes yapalÄ±m: 4 sn al, 4 tut, 6 ver. YanÄ±ndayÄ±m."
                           : "I take this seriously. **Your safety first.** Call someone you trust or local emergency (TR: **112**). We can do 4-4-6 breathing: inhale 4, hold 4, exhale 6. Iâ€™m here.";
      }
      if(sc<=-1) return lang==="tr" ? `${soft?"Seni duyuyorum. ":""}BÃ¶yle hissetmen anlaÅŸÄ±lÄ±r. ${ground}\n\n${openQ[0]}` :
                                     `${soft?"I hear you. ":""}Itâ€™s understandable to feel this way. ${ground}\n\n${openQ[0]}`;
      if(sc>=1)  return lang==="tr" ? `${soft?"Sevindim! ":""}Bunu korumak iÃ§in **1 kÃ¼Ã§Ã¼k adÄ±m** seÃ§elim: 20 dk odak + 5 dk mola. ${openQ[2]}`
                                     : `${soft?"Nice! ":""}To keep it, pick **one tiny step**: 20m focus + 5m break. ${openQ[2]}`;
      return lang==="tr" ? `${soft?"AnlÄ±yorum. ":""}Ä°ki hat: (1) mini dÃ¼zenleme rutini, (2) kÃ¶k soruya 1-2 adÄ±m. ${openQ[1]}`
                         : `${soft?"Got it. ":""}Two tracks: (1) tiny regulation, (2) 1â€“2 root-cause questions. ${openQ[1]}`;
    }
    function replyAssistant(lang, text){
      const L=text.toLowerCase();
      if(/(selam|merhaba|hello|hi)\b/.test(L)) return lang==="tr" ? "Selam! NasÄ±l yardÄ±mcÄ± olabilirim? Hedefini yaz, 3 kÃ¼Ã§Ã¼k adÄ±ma bÃ¶lelim." :
                                                                    "Hey! How can I help? Share a goal, weâ€™ll break it into 3 tiny steps.";
      if(/(plan|Ã§alÄ±ÅŸma planÄ±|study plan)/.test(L)) return lang==="tr"
        ? "HÄ±zlÄ± plan: 25 dk odak Ã— 3, 10 dk Ã¶zet, 15 dk test. AkÅŸam 20 dk tekrar."
        : "Quick plan: 25m focus Ã— 3, 10m notes, 15m quiz. Evening 20m review.";
      if(/(3 kÃ¼Ã§Ã¼k adÄ±m|3 small steps|3 steps)/.test(L)) return lang==="tr"
        ? "BugÃ¼n 3 adÄ±m: (1) 15 dk dÃ¼zen, (2) 20 dk tek gÃ¶rev, (3) 5 dk mini rapor."
        : "Three steps: (1) 15m tidy, (2) 20m single-task, (3) 5m mini report.";
      return lang==="tr" ? "AnladÄ±m. 1 hedef, 1 engel, 1 sonraki adÄ±m yazalÄ±m mÄ±? Ä°stersem ÅŸablon verebilirim."
                         : "Got it. Shall we note 1 goal, 1 obstacle, 1 next step? I can share a template.";
    }
    function composeReply(text){
      const lang = detectLang(text);
      return MODE==="empathy" ? replyEmpathy(lang,text) : replyAssistant(lang,text);
    }

    // ======= Render + Ã§eviri Ã§izgisi
    function fmt(t){ return new Date(t).toLocaleTimeString("tr-TR",{hour:'2-digit',minute:'2-digit'}); }
    function esc(x){ return (x||"").replace(/</g,"&lt;"); }
    function render(){
      // global akÄ±ÅŸ (admin gÃ¶rsÃ¼n) + oda filtresi (yerel)
      const all = YANLIK_AUTH.listChats(); // {id,at,from,role,text}
      const room = ROOMS.current;
      const roomLog = readRoomLog(room);   // {text,room} iÃ§erenler
      // birleÅŸtir (aynÄ± dizene koy)
      const merged = mergeLogs(all, roomLog);
      document.title = `Yanlik â€¢ #${room}`;
      // Ã§eviri hedefi
      const showTrans = TR_TARGET!=="off";
      list.innerHTML = merged.slice(-200).map(m=>{
        // Ã§eviri yalnÄ±zca gÃ¶rÃ¼ntÃ¼ tarafÄ±nda, ham kaydÄ± bozma
        let tr = "";
        if(showTrans){
          const srcLang = detectLang(m.text);
          if(TR_TARGET==="tr" && srcLang!=="tr") tr = naiveTranslate(m.text,"tr");
          if(TR_TARGET==="en" && srcLang!=="en") tr = naiveTranslate(m.text,"en");
        }
        return `
        <div class="msg ${m.from===me.username?'me':''}">
          <div class="meta">${fmt(m.at)} â€¢ <strong>${esc(m.from)}</strong> [${m.role}] â€¢ #${esc(m.room||'Genel')}</div>
          <div>${esc(m.text)}</div>
          ${tr && tr!==m.text ? `<div class="trline">â†³ ${esc(tr)}</div>` : ""}
        </div>`;
      }).join("");
      list.scrollTop = list.scrollHeight;
      renderTemplates();
    }

    // Yerel oda logu (admin globaline ek)
    const LS_ROOM_LOG = (room)=>`yanlik:roomlog:${room}`;
    function readRoomLog(room){ try{ return JSON.parse(localStorage.getItem(LS_ROOM_LOG(room))) || []; }catch{ return []; } }
    function pushRoomLog(room, item){
      const arr = readRoomLog(room);
      arr.push(item);
      if(arr.length>1000) arr.shift();
      localStorage.setItem(LS_ROOM_LOG(room), JSON.stringify(arr));
    }
    // global + oda logunu zaman damgasÄ±na gÃ¶re kaba birleÅŸtir
    function mergeLogs(globalArr, roomArr){
      const tag = (x)=> ({ id:x.id||("loc_"+Math.random().toString(36).slice(2,8)), at:x.at, from:x.from, role:x.role, text:x.text, room:x.room });
      const all = [...(globalArr||[]).map(m=>tag({...m, room: m.room||"Genel"})), ...(roomArr||[]).map(tag)];
      return all.sort((a,b)=> new Date(a.at)-new Date(b.at));
    }

    // ======= GÃ¶nderim
    async function send(){
      const text = input.value.trim();
      if(!text) return;
      const room = ROOMS.current;

      // 1) global akÄ±ÅŸa bas (admin de gÃ¶rsÃ¼n)
      YANLIK_AUTH.pushChat({ from: me.username, role: me.role, text });
      // 2) odalÄ± kopyayÄ± yerel loga bas
      pushRoomLog(room, { id:"m_"+Math.random().toString(36).slice(2,9), at:new Date().toISOString(), from:me.username, role:me.role, text, room });

      input.value=""; render();

      // typing simÃ¼lasyon
      typing.style.display="inline-flex";
      await new Promise(r=>setTimeout(r, Math.min(1200, 300 + text.length*15)));

      const botText = composeReply(text);

      // botâ€™u da iki tarafa yaz
      YANLIK_AUTH.pushChat({ from:"YanlikAI", role:"bot", text: botText });
      pushRoomLog(room, { id:"m_"+Math.random().toString(36).slice(2,9), at:new Date().toISOString(), from:"YanlikAI", role:"bot", text: botText, room });

      typing.style.display="none";
      render();
    }

    // ======= Events
    document.getElementById("logoutBtn").onclick = ()=>{ YANLIK_AUTH.logout(); location.href="login.html"; };
    document.getElementById("sendBtn").onclick = send;
    document.getElementById("msgInput").addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });

    // ======= Ä°lk Ã§izim + periyodik yenileme
    render();
    setInterval(render, 5000);
  </script>
</body>
</html>