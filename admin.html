<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Yanlik • Admin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{font-family:system-ui;margin:20px;background:#0b1222;color:#e8f0ff}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tabs button{padding:8px 12px;border:0;border-radius:10px;background:#14203a;color:#9fd3ff;cursor:pointer}
    .tabs button.active{background:#00c9ff;color:#02131a;font-weight:700}
    .box{background:#121a2b;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    .muted{color:#9bb3cc}
    .chat{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <script src="./auth.js"></script>
  <script>
    const s = YANLIK_AUTH.requireAuth('login.html', { requireRole: ['owner','admin'] });
    if(!s) document.write("Yönlendiriliyorsunuz...");
  </script>

  <h1>Admin Paneli</h1>
  <div class="row">
    <p id="who" class="muted">Yükleniyor…</p>
    <p>
      <button onclick="YANLIK_AUTH.logout();location.href='login.html'">Çıkış</button>
    </p>
  </div>

  <div class="tabs">
    <button id="tabUsers" class="active">Üyeler</button>
    <button id="tabChats">Sohbetler</button>
  </div>

  <div id="viewUsers" class="box">
    <div class="row" style="margin-bottom:10px">
      <div class="muted">Owner “Ayarlar → IP paylaşımı” açık ise admin IP’yi maskeli görür.</div>
      <button onclick="toggleIpShare()">IP paylaşımı (owner)</button>
    </div>
    <table>
      <thead><tr><th>Kullanıcı</th><th>Görünen İsim</th><th>Rol</th><th>Oluşturma</th><th>Son Giriş</th><th>IP</th></tr></thead>
      <tbody id="uBody"></tbody>
    </table>
  </div>

  <div id="viewChats" class="box" style="display:none">
    <div class="row"><div class="muted">Son 2000 mesajdan en yenileri</div><button onclick="loadChats()">Yenile</button></div>
    <div id="chatList"></div>
  </div>

  <script>
    const sess = YANLIK_AUTH.getSession();
    document.getElementById("who").textContent = `Giriş: ${sess.display} (${sess.role})`;

    const tUsers = document.getElementById("tabUsers");
    const tChats = document.getElementById("tabChats");
    const vUsers = document.getElementById("viewUsers");
    const vChats = document.getElementById("viewChats");
    tUsers.onclick = ()=>{ tUsers.classList.add("active"); tChats.classList.remove("active"); vUsers.style.display="block"; vChats.style.display="none"; };
    tChats.onclick = ()=>{ tChats.classList.add("active"); tUsers.classList.remove("active"); vChats.style.display="block"; vUsers.style.display="none"; };

    function fmt(t){ return t ? new Date(t).toLocaleString() : "-"; }

    function loadUsers(){
      const rows = YANLIK_AUTH.listUsersForAdmin(sess);
      const tb = document.getElementById("uBody");
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.username}</td>
          <td>${r.display||"-"}</td>
          <td>${r.role}</td>
          <td>${fmt(r.createdAt)}</td>
          <td>${fmt(r.lastLoginAt)}</td>
          <td>${r.lastLoginIp||"-"}</td>
        </tr>
      `).join("");
    }

    function loadChats(){
      const list = YANLIK_AUTH.listChats();
      const out = document.getElementById("chatList");
      if(!list.length){ out.innerHTML='<p class="muted">Mesaj yok.</p>'; return; }
      const latest = list.slice(-200).map(m=>`
        <div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06)">
          <div class="muted">${fmt(m.at)} • <strong>${m.from}</strong> [${m.role}]</div>
          <div class="chat">${(m.text||"").replace(/</g,"&lt;")}</div>
        </div>`).join("");
      out.innerHTML = latest;
    }

    function toggleIpShare(){
      if(sess.role!=="owner") return alert("Sadece owner");
      const set = YANLIK_AUTH.getSettings();
      YANLIK_AUTH.setSettings({ ipShareAllowed: !set.ipShareAllowed }, sess);
      alert("Ayar: ipShareAllowed = "+(!set.ipShareAllowed));
      loadUsers();
    }

    loadUsers();
    loadChats();
    setInterval(loadChats, 15000);
  </script>
</body>
</html>