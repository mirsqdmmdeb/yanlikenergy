<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel • Yanlik</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./style.css?v=ui4" />
</head>
<body>
<script src="./auth.js"></script>
<script>
  const wait = setInterval(()=>{
    if(window.YANLIK_AUTH){
      clearInterval(wait);
      // index: misafir serbestse allowGuest:true
      const s = YANLIK_AUTH.requireAuth('./login.html', { allowGuest:true });
      if(!s) document.write("Yönlendiriliyorsunuz...");
      // idle auto-logout (öneri)
      let last = Date.now();
      ['click','keydown','mousemove','touchstart'].forEach(ev=>document.addEventListener(ev,()=>last=Date.now()));
      setInterval(()=>{ if(Date.now()-last>30*60*1000){ YANLIK_AUTH.logout('login.html'); } }, 15000); // 30 dk idle
      setInterval(()=>{ try{ YANLIK_AUTH.pingSession(); }catch{} }, 10000);
    }
  },50);
</script>
<script src="./auth.js"></script>
<script>
  const s = YANLIK_AUTH.requireAuth('./login.html');
  if(!s) document.write("Yönlendiriliyorsunuz...");
</script>
  <script src="./auth.js"></script>
  <script>
// === Sohbet Görüntüleme ===
const convosBox = document.getElementById("convosBox");
document.getElementById("loadConvos").onclick = () => {
  convosBox.innerHTML = "";
  const keys = Object.keys(localStorage).filter(k => k.startsWith("yanlik.convo."));
  if(keys.length === 0){
    convosBox.innerHTML = "<p>Henüz kayıtlı sohbet yok.</p>";
    return;
  }
  keys.forEach((key,i)=>{
    const convo = JSON.parse(localStorage.getItem(key));
    const preview = convo.messages
      ?.filter(m=>m.role==="user")
      .slice(-1)[0]?.text?.slice(0,60) || "(boş)";
    const div = document.createElement("div");
    div.className="thread";
    div.innerHTML = `
      <span class="name">#${i+1} ${key.replace("yanlik.convo.","")}</span>
      <span class="mini">${preview}</span>
      <div class="ops">
        <button class="btn soft tooltip" data-tip="Aç">🔍</button>
        <button class="btn soft tooltip" data-tip="Sil">🗑️</button>
      </div>`;
    div.querySelectorAll("button")[0].onclick=()=>{
      const w = window.open("", "_blank");
      w.document.write("<pre style='white-space:pre-wrap;font-family:monospace;'>"+
        JSON.stringify(convo,null,2)+"</pre>");
      w.document.title = "Sohbet " + key;
    };
    div.querySelectorAll("button")[1].onclick=()=>{
      if(!confirm("Bu sohbet silinsin mi?")) return;
      localStorage.removeItem(key);
      UI.toast("Sohbet silindi","warn");
      div.remove();
    };
    convosBox.appendChild(div);
  });
  UI.toast(`${keys.length} sohbet bulundu`,"success");
};
    const s = YANLIK_AUTH.requireAuth('./login.html');
    if(!s) document.write("Yönlendiriliyorsunuz...");
  </script>

  <main style="padding:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <h2>Admin Panel</h2>
      <div>
        <span style="color:var(--muted);margin-right:10px">Giriş yapan: <strong id="who"></strong></span>
        <button id="logoutBtn" class="btn ghost icon" title="Çıkış">🚪</button>
      </div>
    </div>

    <section style="margin-top:18px;max-width:900px;">
<section style="margin-top:36px;max-width:900px;">
  <h3>Sohbet Kayıtları</h3>
  <button class="btn soft" id="loadConvos">Sohbetleri Göster</button>
  <div id="convosBox" style="margin-top:10px;"></div>
</section>

      <h3>Kullanıcılar</h3>
      <div id="usersBox" style="margin-top:10px"></div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <input id="newUserName" placeholder="kullanıcı adı" />
        <input id="newUserPass" placeholder="parola" />
        <button id="addUser" class="btn primary">Ekle</button>
      </div>
    </section>
  </main>

  <script src="./ui.js?v=ui4"></script>
  <script>
    const KEY="yanlik.auth.users.v1";
    const who=document.getElementById("who");
    const sess=YANLIK_AUTH.getSession();
    who.textContent=sess?.display||sess?.username||"—";
    const usersBox=document.getElementById("usersBox");
    const getUsers=()=>JSON.parse(localStorage.getItem(KEY)||"[]");
    const saveUsers=(arr)=>localStorage.setItem(KEY,JSON.stringify(arr));
    const render=()=>{
      usersBox.innerHTML="";
      getUsers().forEach((u,i)=>{
        const row=document.createElement("div");
        row.className="thread";
        row.innerHTML=`<span class="name">${u.username}</span>
          <span class="mini">${u.display||""}</span>
          <div class="ops">
            <button class="btn soft tooltip" data-tip="Şifre değiştir">🔑</button>
            <button class="btn soft tooltip" data-tip="Sil">🗑️</button>
          </div>`;
        row.querySelectorAll("button")[0].onclick=()=>{
          const nw=prompt("Yeni parola:"); if(!nw) return;
          const list=getUsers(); list[i].password=nw; saveUsers(list); UI.toast("Parola güncellendi","success"); render();
        };
        row.querySelectorAll("button")[1].onclick=()=>{
          if(!confirm("Kullanıcı silinsin mi?")) return;
          const list=getUsers(); list.splice(i,1); saveUsers(list); UI.toast("Kullanıcı silindi","warn"); render();
        };
        usersBox.appendChild(row);
      });
    };
    render();
    document.getElementById("addUser").onclick=()=>{
      const n=document.getElementById("newUserName").value.trim();
      const p=document.getElementById("newUserPass").value.trim();
      if(!n||!p) return UI.toast("Boş bırakma","error");
      const arr=getUsers();
      if(arr.find(x=>x.username===n)) return UI.toast("Kullanıcı var","warn");
      arr.push({username:n,password:p});
      saveUsers(arr); render(); UI.toast("Eklendi","success");
    };
    document.getElementById("logoutBtn").onclick=()=>YANLIK_AUTH.logout("index.html");
  </script>
</body>
</html>